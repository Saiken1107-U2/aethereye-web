<section *ngIf="!cargando && !errorCarga" class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <h2 class="text-2xl font-bold mb-6">Mi Perfil</h2>

  <form [formGroup]="form" (ngSubmit)="guardar()" class="space-y-4">
    <div>
      <label class="block mb-1 font-medium">Nombre completo</label>
      <input type="text" formControlName="nombreCompleto" class="w-full border rounded px-4 py-2" />
      <div *ngIf="form.get('nombreCompleto')?.invalid && form.get('nombreCompleto')?.touched" 
           class="text-red-500 text-sm mt-1">
        El nombre completo es requerido
      </div>
    </div>

    <div>
      <label class="block mb-1 font-medium">Correo electrónico</label>
      <input type="email" formControlName="correo" class="w-full border rounded px-4 py-2" />
      <div *ngIf="form.get('correo')?.invalid && form.get('correo')?.touched" 
           class="text-red-500 text-sm mt-1">
        <span *ngIf="form.get('correo')?.errors?.['required']">El correo es requerido</span>
        <span *ngIf="form.get('correo')?.errors?.['email']">El formato del correo no es válido</span>
      </div>
    </div>

    <div class="text-center mt-6">
      <button type="submit" [disabled]="form.invalid" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
        Guardar Cambios
      </button>
    </div>

    <div *ngIf="exito" class="text-green-600 text-center mt-4">¡Datos actualizados correctamente!</div>
    <div *ngIf="error" class="text-red-600 text-center mt-4">Error al actualizar los datos. Inténtalo de nuevo.</div>
  </form>

  <!-- Sección de cambio de contraseña -->
  <div class="mt-8 border-t pt-6">
    <div class="text-center mb-4">
      <button type="button" 
              (click)="toggleCambioPassword()" 
              class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
        {{ mostrarCambioPassword ? 'Cancelar cambio de contraseña' : 'Cambiar contraseña' }}
      </button>
    </div>

    <div *ngIf="mostrarCambioPassword" class="bg-gray-50 p-4 rounded">
      <h3 class="text-lg font-semibold mb-4">Cambiar Contraseña</h3>
      
      <form [formGroup]="passwordForm" (ngSubmit)="cambiarPassword()" class="space-y-4">
        <div>
          <label class="block mb-1 font-medium">Contraseña actual</label>
          <input type="password" formControlName="contrasenaActual" class="w-full border rounded px-4 py-2" />
          <div *ngIf="passwordForm.get('contrasenaActual')?.invalid && passwordForm.get('contrasenaActual')?.touched" 
               class="text-red-500 text-sm mt-1">
            La contraseña actual es requerida
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium">Nueva contraseña</label>
          <input type="password" formControlName="contrasenaNueva" class="w-full border rounded px-4 py-2" />
          <div *ngIf="passwordForm.get('contrasenaNueva')?.invalid && passwordForm.get('contrasenaNueva')?.touched" 
               class="text-red-500 text-sm mt-1">
            <span *ngIf="passwordForm.get('contrasenaNueva')?.errors?.['required']">La nueva contraseña es requerida</span>
            <span *ngIf="passwordForm.get('contrasenaNueva')?.errors?.['minlength']">La contraseña debe tener al menos 6 caracteres</span>
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium">Confirmar nueva contraseña</label>
          <input type="password" formControlName="confirmarContrasena" class="w-full border rounded px-4 py-2" />
          <div *ngIf="passwordForm.get('confirmarContrasena')?.invalid && passwordForm.get('confirmarContrasena')?.touched" 
               class="text-red-500 text-sm mt-1">
            La confirmación de contraseña es requerida
          </div>
          <div *ngIf="passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmarContrasena')?.touched" 
               class="text-red-500 text-sm mt-1">
            Las contraseñas no coinciden
          </div>
        </div>

        <div class="text-center mt-6">
          <button type="submit" 
                  [disabled]="passwordForm.invalid || cargandoPassword" 
                  class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition disabled:bg-gray-400">
            <span *ngIf="cargandoPassword">Cambiando...</span>
            <span *ngIf="!cargandoPassword">Cambiar Contraseña</span>
          </button>
        </div>

        <div *ngIf="exitoPassword" class="text-green-600 text-center mt-4">¡Contraseña cambiada correctamente!</div>
        <div *ngIf="errorPassword" class="text-red-600 text-center mt-4">Error al cambiar la contraseña. Verifica tu contraseña actual.</div>
      </form>
    </div>
  </div>
</section>

<!-- Mensaje de error de carga -->
<section *ngIf="errorCarga" class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <div class="text-center">
    <h2 class="text-2xl font-bold mb-4 text-red-600">Error al cargar perfil</h2>
    <p class="text-gray-600 mb-4">No se pudieron cargar los datos de tu perfil.</p>
    <button (click)="recargarPerfil()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      Reintentar
    </button>
  </div>
</section>

<!-- Indicador de carga -->
<section *ngIf="cargando" class="max-w-xl mx-auto bg-white p-6 rounded shadow">
  <div class="text-center">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="mt-2 text-gray-600">Cargando perfil...</p>
  </div>
</section>
