<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Gestión de Recetas - Explosión de Materiales</h1>
    <button 
      type="button"
      (click)="abrirFormulario()"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
      Nueva Receta
    </button>
  </div>

  <!-- Alertas -->
  @if (error) {
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      {{ error }}
    </div>
  }

  @if (success) {
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
      {{ success }}
    </div>
  }

  <!-- Selector de Producto -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="text-lg font-semibold mb-4">Filtrar por Producto</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <select
          [(ngModel)]="productoSeleccionado"
          (ngModelChange)="seleccionarProducto($event)"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option [value]="null">Todos los productos</option>
          @for (producto of productos; track producto.id) {
            <option [value]="producto.id">{{ producto.nombre }} - ${{ producto.precioUnitario | number:'1.2-2' }}</option>
          }
        </select>
      </div>
      <div class="flex space-x-2">
        @if (productoSeleccionado) {
          <button 
            (click)="verRecetaCompleta(productoSeleccionado)"
            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
            Análisis de Costos
          </button>
          <button 
            (click)="abrirExplosion(productoSeleccionado)"
            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
            Explosión de Materiales
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="mt-2 text-gray-600">Cargando...</p>
    </div>
  }

  <!-- Tabla de Recetas -->
  @if (!loading) {
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Producto
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Insumo/Material
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Cantidad Necesaria
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Costo Unitario
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Costo Total Línea
            </th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @if (recetas.length > 0) {
            @for (receta of recetas; track receta.id) {
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">
                    {{ getNombreProducto(receta.productoId) }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">{{ getNombreInsumo(receta.insumoId) }}</div>
                  <div class="text-sm text-gray-500">{{ getUnidadMedida(receta.insumoId) }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ receta.cantidadNecesaria | number:'1.2-2' }} {{ getUnidadMedida(receta.insumoId) }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${{ receta.insumo?.costoUnitario | number:'1.2-2' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  ${{ calcularCostoLinea(receta) | number:'1.2-2' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm space-x-2">
                  <button 
                    (click)="editarReceta(receta)"
                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Editar
                  </button>
                  <button 
                    (click)="eliminarReceta(receta)"
                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Eliminar
                  </button>
                </td>
              </tr>
            }
          } @else {
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                @if (productoSeleccionado) {
                  No hay recetas definidas para este producto
                } @else {
                  No hay recetas definidas
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Modal Formulario -->
  @if (mostrarFormulario) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">{{ isEditing ? 'Editar Receta' : 'Nueva Receta' }}</h2>
          <button 
            type="button"
            (click)="cerrarFormulario()"
            class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <form [formGroup]="recetaForm" (ngSubmit)="guardarReceta()">
          <!-- Producto -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Producto *
            </label>
            <select
              formControlName="productoId"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="isFieldInvalid('productoId')">
              <option value="">Seleccionar producto</option>
              @for (producto of productos; track producto.id) {
                <option [value]="producto.id">{{ producto.nombre }}</option>
              }
            </select>
            @if (isFieldInvalid('productoId')) {
              <p class="text-red-500 text-sm mt-1">{{ getFieldError('productoId') }}</p>
            }
          </div>

          <!-- Insumo -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Insumo/Material *
            </label>
            <select
              formControlName="insumoId"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="isFieldInvalid('insumoId')">
              <option value="">Seleccionar insumo</option>
              @for (insumo of insumos; track insumo.id) {
                <option [value]="insumo.id">{{ insumo.nombre }} ({{ insumo.unidadMedida }})</option>
              }
            </select>
            @if (isFieldInvalid('insumoId')) {
              <p class="text-red-500 text-sm mt-1">{{ getFieldError('insumoId') }}</p>
            }
          </div>

          <!-- Cantidad Necesaria -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Cantidad Necesaria *
            </label>
            <input
              type="number"
              step="1"
              min="1"
              formControlName="cantidadNecesaria"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="isFieldInvalid('cantidadNecesaria')"
              placeholder="Ej: 1, 2, 5">
            @if (isFieldInvalid('cantidadNecesaria')) {
              <p class="text-red-500 text-sm mt-1">{{ getFieldError('cantidadNecesaria') }}</p>
            }
          </div>

          <!-- Unidad de Medida -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Unidad de Medida *
            </label>
            <select
              formControlName="unidadMedida"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              [class.border-red-500]="isFieldInvalid('unidadMedida')">
              <option value="">Seleccionar unidad</option>
              <option value="pieza">Pieza</option>
              <option value="unidad">Unidad</option>
              <option value="componente">Componente</option>
              <option value="módulo">Módulo</option>
              <option value="sensor">Sensor</option>
              <option value="cable">Cable</option>
            </select>
            @if (isFieldInvalid('unidadMedida')) {
              <p class="text-red-500 text-sm mt-1">{{ getFieldError('unidadMedida') }}</p>
            }
          </div>

          <!-- Botones -->
          <div class="flex justify-end space-x-2">
            <button 
              type="button"
              (click)="cerrarFormulario()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
              Cancelar
            </button>
            <button 
              type="submit"
              [disabled]="recetaForm.invalid || loading"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
              {{ isEditing ? 'Actualizar' : 'Crear' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal Análisis de Costos -->
  @if (mostrarRecetaCompleta && recetaCompleta) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold">Análisis de Costos - {{ recetaCompleta.producto.nombre }}</h2>
          <button 
            type="button"
            (click)="cerrarRecetaCompleta()"
            class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Resumen de Costos -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <div class="text-lg font-bold text-blue-600">${{ recetaCompleta.costoTotal | number:'1.2-2' }}</div>
            <div class="text-sm text-blue-800">Costo Total Materiales</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <div class="text-lg font-bold text-green-600">${{ recetaCompleta.producto.precioUnitario | number:'1.2-2' }}</div>
            <div class="text-sm text-green-800">Precio de Venta</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
            <div class="text-lg font-bold text-purple-600">{{ recetaCompleta.margenUtilidad | number:'1.1-1' }}%</div>
            <div class="text-sm text-purple-800">Margen de Utilidad</div>
          </div>
        </div>

        <!-- Detalle de Receta -->
        <div class="bg-white border rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Costo Unit.</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Costo Total</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (receta of recetaCompleta.recetas; track receta.id) {
                <tr>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    {{ receta.insumo?.nombre }}
                    <span class="text-gray-500">({{ receta.insumo?.unidadMedida }})</span>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    {{ receta.cantidadNecesaria | number:'1.2-2' }}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    ${{ receta.insumo?.costoUnitario | number:'1.2-2' }}
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-gray-900">
                    ${{ calcularCostoLinea(receta) | number:'1.2-2' }}
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }

  <!-- Modal Explosión de Materiales -->
  @if (mostrarExplosion) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-6xl max-h-[95vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">
            <svg class="w-8 h-8 inline-block mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Explosión de Materiales - BOM
          </h2>
          <button 
            type="button"
            (click)="cerrarExplosion()"
            class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Formulario de Explosión -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <form [formGroup]="explosionForm" (ngSubmit)="calcularExplosion()">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                <select
                  formControlName="productoId"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">Seleccionar producto</option>
                  @for (producto of productos; track producto.id) {
                    <option [value]="producto.id">{{ producto.nombre }}</option>
                  }
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad a Producir</label>
                <input
                  type="number"
                  min="1"
                  formControlName="cantidadProductos"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
              </div>
              <div class="flex items-end">
                <button 
                  type="submit"
                  [disabled]="explosionForm.invalid || loading"
                  class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors disabled:opacity-50">
                  Calcular Explosión
                </button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
              <label class="flex items-center">
                <input type="checkbox" formControlName="incluirSubrecetas" class="mr-2">
                <span class="text-sm text-gray-700">Incluir subrecetas</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" formControlName="verificarStock" class="mr-2">
                <span class="text-sm text-gray-700">Verificar stock disponible</span>
              </label>
            </div>
          </form>
        </div>

        <!-- Resultados de Explosión -->
        @if (explosionMateriales) {
          <div class="space-y-6">
            <!-- Resumen -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="text-2xl font-bold text-blue-600">{{ explosionMateriales.cantidadProductos }}</div>
                <div class="text-sm text-blue-800">Unidades a Producir</div>
              </div>
              <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="text-2xl font-bold text-green-600">${{ explosionMateriales.costoTotalMateriales | number:'1.2-2' }}</div>
                <div class="text-sm text-green-800">Costo Base Materiales</div>
              </div>
              <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                <div class="text-2xl font-bold text-orange-600">${{ explosionMateriales.costoTotalConMerma | number:'1.2-2' }}</div>
                <div class="text-sm text-orange-800">Costo con Merma</div>
              </div>
              <div class="rounded-lg p-4 border-2" [class]="explosionMateriales.tieneFaltantes ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'">
                <div class="text-2xl font-bold" [class]="explosionMateriales.tieneFaltantes ? 'text-red-600' : 'text-green-600'">
                  {{ explosionMateriales.tieneFaltantes ? 'FALTAN' : 'STOCK OK' }}
                </div>
                <div class="text-sm" [class]="explosionMateriales.tieneFaltantes ? 'text-red-800' : 'text-green-800'">
                  Estado del Stock
                </div>
              </div>
            </div>

            <!-- Alertas de Faltantes -->
            @if (explosionMateriales.alertasFaltantes && explosionMateriales.alertasFaltantes.length > 0) {
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h4 class="text-red-800 font-semibold mb-2">⚠️ Materiales Faltantes:</h4>
                <ul class="text-red-700 text-sm space-y-1">
                  @for (alerta of explosionMateriales.alertasFaltantes; track $index) {
                    <li>• {{ alerta }}</li>
                  }
                </ul>
                @if (explosionMateriales.tieneFaltantes) {
                  <button 
                    (click)="generarSolicitudCompra()"
                    class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    Generar Solicitud de Compra Automática
                  </button>
                }
              </div>
            }

            <!-- Lista de Materiales -->
            <div class="bg-white border rounded-lg overflow-hidden">
              <div class="bg-gray-50 px-6 py-3 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Lista de Materiales Requeridos</h3>
              </div>
              
              <!-- Función recursiva para mostrar items -->
              <div class="divide-y divide-gray-200">
                @for (item of explosionMateriales.items; track $index) {
                  <!-- Item principal -->
                  <div class="px-6 py-4" [class]="'ml-' + (item.nivel * 4)">
                    <div class="grid grid-cols-12 gap-4 items-center">
                      <div class="col-span-3">
                        <div class="flex items-center">
                          @if (item.nivel > 0) {
                            <span class="text-gray-400 mr-2">{{ '└─'.repeat(item.nivel) }}</span>
                          }
                          <div>
                            <div class="font-medium text-gray-900">{{ item.nombre }}</div>
                            <div class="text-sm text-gray-500">{{ item.tipo }}</div>
                          </div>
                        </div>
                      </div>
                      <div class="col-span-2 text-sm">
                        <div>{{ item.cantidadUnitaria | number:'1.2-2' }} {{ item.unidadMedida }}</div>
                        <div class="text-gray-500">por unidad</div>
                      </div>
                      <div class="col-span-2 text-sm">
                        <div class="font-medium">{{ item.cantidadTotal | number:'1.2-2' }} {{ item.unidadMedida }}</div>
                        @if (item.porcentajeMerma > 0) {
                          <div class="text-orange-600">+{{ item.cantidadConMerma - item.cantidadTotal | number:'1.2-2' }} merma</div>
                        }
                      </div>
                      <div class="col-span-2 text-sm">
                        <div>Stock: {{ item.stockActual | number:'1.2-2' }}</div>
                        <div class="text-gray-500">Disponible: {{ item.stockDisponible | number:'1.2-2' }}</div>
                      </div>
                      <div class="col-span-2 text-sm text-right">
                        <div class="font-medium">${{ item.costoTotal | number:'1.2-2' }}</div>
                        <div class="text-gray-500">${{ item.costoUnitario | number:'1.2-2' }}/{{ item.unidadMedida }}</div>
                      </div>
                      <div class="col-span-1 text-center">
                        @if (item.tieneFaltante) {
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Faltante
                          </span>
                        } @else {
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            OK
                          </span>
                        }
                        @if (item.esCritico) {
                          <div class="text-xs text-red-600 mt-1">⚠️ Crítico</div>
                        }
                      </div>
                    </div>
                    @if (item.observaciones) {
                      <div class="mt-2 text-sm text-gray-600 italic">{{ item.observaciones }}</div>
                    }
                  </div>

                  <!-- Sub-items (recursivos) -->
                  @for (subItem of item.subItems; track $index) {
                    <div class="px-6 py-3 bg-gray-25" [class]="'ml-' + ((subItem.nivel) * 6)">
                      <div class="grid grid-cols-12 gap-4 items-center text-sm">
                        <div class="col-span-3">
                          <div class="flex items-center">
                            <span class="text-gray-400 mr-2">{{ '  └─'.repeat(subItem.nivel) }}</span>
                            <div>
                              <div class="font-medium text-gray-800">{{ subItem.nombre }}</div>
                              <div class="text-xs text-gray-500">{{ subItem.tipo }}</div>
                            </div>
                          </div>
                        </div>
                        <div class="col-span-2">
                          <div>{{ subItem.cantidadUnitaria | number:'1.2-2' }} {{ subItem.unidadMedida }}</div>
                        </div>
                        <div class="col-span-2">
                          <div class="font-medium">{{ subItem.cantidadTotal | number:'1.2-2' }} {{ subItem.unidadMedida }}</div>
                        </div>
                        <div class="col-span-2">
                          <div>{{ subItem.stockActual | number:'1.2-2' }} / {{ subItem.stockDisponible | number:'1.2-2' }}</div>
                        </div>
                        <div class="col-span-2 text-right">
                          <div class="font-medium">${{ subItem.costoTotal | number:'1.2-2' }}</div>
                        </div>
                        <div class="col-span-1 text-center">
                          @if (subItem.tieneFaltante) {
                            <span class="inline-flex items-center px-1 py-0.5 rounded text-xs bg-red-100 text-red-800">Falta</span>
                          } @else {
                            <span class="inline-flex items-center px-1 py-0.5 rounded text-xs bg-green-100 text-green-800">OK</span>
                          }
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Modal Solicitud de Compra Automática -->
  @if (mostrarSolicitudCompra && solicitudCompra) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-800">
            <svg class="w-6 h-6 inline-block mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            Solicitud de Compra Automática
          </h2>
          <button 
            type="button"
            (click)="cerrarSolicitudCompra()"
            class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Resumen de la Solicitud -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <div class="text-sm text-blue-800">Producto Objetivo</div>
              <div class="font-semibold text-blue-900">{{ getNombreProducto(solicitudCompra.productoObjetivo) }}</div>
            </div>
            <div>
              <div class="text-sm text-blue-800">Cantidad Objetivo</div>
              <div class="font-semibold text-blue-900">{{ solicitudCompra.cantidadObjetivo }} unidades</div>
            </div>
            <div>
              <div class="text-sm text-blue-800">Monto Total Estimado</div>
              <div class="text-xl font-bold text-blue-900">${{ solicitudCompra.montoEstimado | number:'1.2-2' }}</div>
            </div>
          </div>
        </div>

        <!-- Lista de Items a Comprar -->
        <div class="bg-white border rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b">
            <h3 class="font-semibold text-gray-800">Materiales a Comprar</h3>
          </div>
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Material</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad Faltante</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Costo Unitario</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto Total</th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Prioridad</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              @for (item of solicitudCompra.items; track $index) {
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3">
                    <div class="text-sm font-medium text-gray-900">{{ item.insumoNombre }}</div>
                    <div class="text-sm text-gray-500">{{ item.unidadMedida }}</div>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    {{ item.cantidadFaltante | number:'1.2-2' }} {{ item.unidadMedida }}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900">
                    ${{ item.costoUnitarioEstimado | number:'1.2-2' }}
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-gray-900">
                    ${{ item.montoTotal | number:'1.2-2' }}
                  </td>
                  <td class="px-4 py-3 text-center">
                    @if (item.esCritico) {
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        CRÍTICO
                      </span>
                    } @else {
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Normal
                      </span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Acciones -->
        <div class="flex justify-end space-x-3 mt-6">
          <button 
            type="button"
            (click)="cerrarSolicitudCompra()"
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            Cerrar
          </button>
          <button 
            type="button"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            Enviar a Compras
          </button>
          <button 
            type="button"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
            Exportar PDF
          </button>
        </div>
      </div>
    </div>
  }
</div>
